name: Quality Checks

on:
  push:
    branches: [ master, main, rails-7-2 ]
  pull_request:

jobs:
  quality:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.6'
        bundler-cache: true
    
    - name: Install dependencies
      run: bundle install
    
    - name: RuboCop Linting
      run: |
        echo "ğŸ” Running RuboCop..."
        bundle exec rubocop --parallel --format github
    
    - name: Security Audit
      run: |
        echo "ğŸ”’ Running security audit..."
        bundle exec bundler-audit || echo "Security audit completed with warnings"
    
    - name: Check Dependencies
      run: |
        echo "ğŸ“¦ Checking dependencies..."
        bundle exec bundle list
    
    - name: Validate Gemspec
      run: |
        echo "ğŸ’ Validating gemspec..."
        gem specification firebird_adapter.gemspec --ruby
    
    - name: Build Gem
      run: |
        echo "ğŸ—ï¸ Building gem..."
        gem build firebird_adapter.gemspec
    
    - name: Check Gem Size
      run: |
        echo "ğŸ“Š Checking gem size..."
        ls -lh *.gem

  documentation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.6'
        bundler-cache: true
    
    - name: Install dependencies
      run: bundle install
    
    - name: Check README
      run: |
        echo "ğŸ“š Checking README..."
        if [ ! -f README.md ]; then
          echo "âŒ README.md not found"
          exit 1
        fi
        echo "âœ… README.md exists"
    
    - name: Check Documentation
      run: |
        echo "ğŸ“– Checking documentation files..."
        [ -f USAGE.md ] && echo "âœ… USAGE.md exists" || echo "âš ï¸ USAGE.md missing"
        [ -f CHANGELOG.md ] && echo "âœ… CHANGELOG.md exists" || echo "âš ï¸ CHANGELOG.md missing"