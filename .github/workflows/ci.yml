name: CI - Firebird Adapter

on:
  push:
    branches: [ master, main, rails-7-2 ]
  pull_request:
    branches: [ master, main, rails-7-2 ]

jobs:
  test:
    runs-on: ubuntu-22.04

    services:
      firebird:
        image: firebirdsql/firebird:latest
        env:
          FIREBIRD_PASSWORD: masterkey
          ISC_PASSWORD: masterkey
        options: >-
          --health-cmd "isql-fb -user SYSDBA -password masterkey -h localhost"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 10
        ports:
          - 3050:3050

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.6'
        rubygems: latest

    - name: Install Firebird Client Libraries
      run: |
        sudo apt-get update
        sudo apt-get install -y firebird-dev libfbclient2 netcat-openbsd
        echo "FIREBIRD_INCLUDE=/usr/include/firebird" >> $GITHUB_ENV
        echo "FIREBIRD_LIB=/usr/lib/x86_64-linux-gnu" >> $GITHUB_ENV

    - name: Check Firebird Headers
      run: |
        ls -la /usr/include/firebird/ || echo "No firebird headers found"
        find /usr -name "ibase.h" 2>/dev/null || echo "No ibase.h found"

    - name: Install Dependencies
      run: |
        bundle install

    - name: Check Installation
      run: |
        bundle list | grep fb
        ruby -r fb -e "puts 'FB gem loaded successfully'" || echo "FB gem not available"

    - name: Wait for Firebird
      run: |
        echo "Waiting for Firebird to be ready..."
        for i in {1..30}; do
          if nc -z localhost 3050; then
            echo "Firebird is ready!"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done

    - name: Run Tests
      env:
        DB_HOST: firebird
      run: |
        echo "Running basic tests..."
        ruby -c lib/firebird_adapter.rb

        echo "Running RSpec tests..."
        bundle exec rspec --format documentation || true