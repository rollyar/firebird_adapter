name: CI - Firebird Adapter

on:
  push:
    branches: [ rails-7-2, main ]
  pull_request:
    branches: [ rails-7-2, main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ruby: [ '3.3.6' ]
        rails: [ '7-2-stable' ]
        firebird: [ '4.0.5' ]

    env:
      ISC_PASSWORD: masterkey
      FIREBIRD_DATABASE: /firebird/data/test.fdb

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby }}
        bundler-cache: true
        cache-version: 1

    - name: Install Firebird
      run: |
        echo "Setting up Firebird ${{ matrix.firebird }}..."
        
        # Install dependencies
        sudo apt-get update
        sudo apt-get install -y wget tar
        
        # Download and install Firebird
        case "${{ matrix.firebird }}" in
          4.0.5)
            FIREBIRD_PACKAGE=firebird4.0-classic
            ;;
          *)
            echo "Unsupported Firebird version: ${{ matrix.firebird }}"
            exit 1
            ;;
        esac
        
        wget -q "https://github.com/FirebirdSQL/firebird/releases/download/v4.0.5/${FIREBIRD_PACKAGE}-ubuntu20.04-amd64.tar.gz"
        sudo tar -xzf ${FIREBIRD_PACKAGE}-ubuntu20.04-amd64.tar.gz -C /opt/
        
        # Set up links and permissions
        sudo ln -sf /opt/${FIREBIRD_PACKAGE}/opt/firebird /opt/firebird
        sudo ln -sf /opt/firebird/bin/isql /usr/local/bin/isql
        sudo chmod -R 755 /opt/firebird
        
        # Create database directory
        sudo mkdir -p /firebird/data
        sudo chmod 777 /firebird/data
        
        # Start Firebird service
        sudo /opt/firebird/firebird.sh start || true
        sleep 5

    - name: Setup Database
      run: |
        # Create test database
        isql -user sysdba -password masterkey -q "CREATE DATABASE '/firebird/data/test.fdb' USER 'sysdba' PASSWORD 'masterkey'" || echo "Database already exists"

    - name: Install Dependencies
      run: |
        bundle config set --local without 'development'
        bundle install --jobs 4 --retry 3

    - name: Run Tests
      run: |
        echo "Ruby version: $(ruby --version)"
        echo "Rails version: $(ruby -e 'require \"bundler\"; puts Bundler.locked_gems[\"rails\"].version rescue \"unknown\"')"
        echo "Firebird version: ${{ matrix.firebird }}"
        
        # Run tests
        mkdir -p tmp
        bundle exec rspec --format documentation --format RspecJunitFormatter --out tmp/test-results.xml || true

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.ruby }}-${{ matrix.rails }}-${{ matrix.firebird }}
        path: tmp/test-results.xml

    - name: Test Summary
      if: always()
      run: |
        echo "## Test Summary"
        echo "- Ruby: ${{ matrix.ruby }}"
        echo "- Rails: ${{ matrix.rails }}"
        echo "- Firebird: ${{ matrix.firebird }}"
        
        # Create status badge
        if [ "${{ job.status }}" = "success" ]; then
          echo "✅ Tests passed"
        else
          echo "❌ Tests failed"
        fi

  # Lint job
  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.6'
        bundler-cache: true

    - name: Install Dependencies
      run: |
        bundle config set --local without 'development'
        bundle install

    - name: Run RuboCop
      run: |
        bundle exec rubocop --format github || true

  # Security scan
  security:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Security Audit
      run: |
        gem install bundler-audit
        bundle audit --update || true