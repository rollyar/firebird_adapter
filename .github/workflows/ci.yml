name: CI - Firebird Adapter

on:
  push:
    branches: [ master, main, rails-7-2 ]
  pull_request:
    branches: [ master, main, rails-7-2 ]

jobs:
  test:
    runs-on: ubuntu-22.04

    services:
      firebird:
        image: firebirdsql/firebird:latest
        env:
          ISC_PASSWORD: masterkey
        options: >-
          --health-cmd "bash -c 'echo \"SELECT 1 FROM RDB\\\$DATABASE;\" | isql-fb -user SYSDBA -password masterkey localhost:3050 2>&1 | grep -q \"1\"'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        ports:
          - 3050:3050

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Firebird Client Libraries
      run: |
        sudo apt-get update
        sudo apt-get install -y firebird-dev libfbclient2 netcat-openbsd

        # Verificar ubicación de headers
        echo "=== Buscando ibase.h ==="
        find /usr -name "ibase.h" 2>/dev/null

        # Crear symlink si es necesario
        if [ -d /usr/include/firebird ] && [ ! -f /usr/include/ibase.h ]; then
          sudo ln -sf /usr/include/firebird/ibase.h /usr/include/ibase.h
          echo "Creado symlink para ibase.h"
        fi

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.6'
        rubygems: latest

    - name: Clean vendor bundle
      run: rm -rf vendor/bundle

    - name: Install Dependencies
      run: |
        bundle config set --local path 'vendor/bundle'
        bundle install

    - name: Verify FB Gem Installation
      run: |
        echo "=== Bundle list ==="
        bundle list | grep -i fb || echo "FB gem not found in bundle"

        echo -e "\n=== Ruby FB gem test (using bundle exec) ==="
        bundle exec ruby -e "
          begin
            require 'fb'
            puts 'FB gem loaded successfully'
            puts 'Version: ' + (defined?(Fb::VERSION) ? Fb::VERSION : 'unknown')
          rescue LoadError => e
            puts 'ERROR: ' + e.message
            exit 1
          end
        "

    - name: Wait for Firebird Service
      run: |
        # Agregar firebird al PATH
        export PATH=$PATH:/usr/lib/x86_64-linux-gnu/firebird/5.0/bin:/opt/firebird/bin

        echo "Waiting for Firebird service on port 3050..."
        for i in {1..30}; do
          if nc -z localhost 3050 2>/dev/null; then
            echo "✓ Port 3050 is open"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done

        echo "Testing database connectivity..."
        for i in {1..15}; do
          if echo "SELECT 1 FROM RDB\$DATABASE;" | isql-fb -user SYSDBA -password masterkey localhost:3050 2>&1 | grep -q "1"; then
            echo "✓ Database is ready and accessible"
            exit 0
          fi
          echo "Waiting for database... ($i/15)"
          sleep 2
        done
        echo "✗ Timeout: Firebird database not ready"
        exit 1

    - name: Run Tests
      env:
        FIREBIRD_HOST: localhost
        FIREBIRD_PORT: 3050
        FIREBIRD_USER: SYSDBA
        FIREBIRD_PASSWORD: masterkey
        FIREBIRD_DATABASE: /tmp/test.fdb
      run: |
        echo "Running syntax check..."
        bundle exec ruby -c lib/firebird_adapter.rb || exit 1

        echo -e "\nRunning RSpec tests..."
        bundle exec rspec --format documentation --color --format RSpec::JUnitFormatter --out tmp/test-results.xml || exit 1

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: tmp/test-results.xml
        retention-days: 7
