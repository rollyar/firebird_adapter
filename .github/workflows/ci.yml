name: CI - Firebird Adapter

on:
  push:
    branches: [ rails-7-2, main ]
  pull_request:
    branches: [ rails-7-2, main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ruby: [ '3.3.6', 'head' ]
        rails: [ '7-2-stable', 'main' ]
        firebird: [ '3.0.11', '4.0.5', '5.0.1' ]
        exclude:
          # Exclude incompatible combinations
          - ruby: 'head'
            rails: '7-2-stable'
            firebird: '3.0.11'

    env:
      ISC_PASSWORD: masterkey
      FIREBIRD_DATABASE: /firebird/data/test.fdb

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby }}
        bundler-cache: true
        cache-version: 1

    - name: Cache RubyGems
      uses: actions/cache@v3
      with:
        path: vendor/bundle/ruby
        key: ${{ runner.os }}-gems-${{ matrix.ruby }}-${{ matrix.rails }}
        restore-keys: |
          ${{ runner.os }}-gems-${{ matrix.ruby }}-${{ matrix.rails }}-
          ${{ runner.os }}-gems-${{ matrix.ruby }}-

    - name: Install Firebird ${{ matrix.firebird }}
      run: |
        echo "Setting up Firebird ${{ matrix.firebird }}..."
        
        # Install Firebird based on version
        case "${{ matrix.firebird }}" in
          3.0.11)
            FIREBIRD_VERSION=3
            FIREBIRD_PACKAGE=firebird3.0-classic
            ;;
          4.0.5)
            FIREBIRD_VERSION=4
            FIREBIRD_PACKAGE=firebird4.0
            ;;
          5.0.1)
            FIREBIRD_VERSION=5
            FIREBIRD_PACKAGE=firebird5.0
            ;;
          *)
            echo "Unsupported Firebird version: ${{ matrix.firebird }}"
            exit 1
            ;;
        esac
        
        # Download and install Firebird
        wget -q "https://github.com/FirebirdSQL/firebird/releases/download/v${FIREBIRD_VERSION}.${FIREBIRD_PACKAGE}.ubuntu20.04/x86_64/${FIREBIRD_PACKAGE}-ubuntu20.04-amd64.tar.gz"
        sudo tar -xzf ${FIREBIRD_PACKAGE}-ubuntu20.04-amd64.tar.gz -C /opt/
        
        # Set up links and permissions
        sudo ln -s /opt/${FIREBIRD_PACKAGE}/opt/firebird /opt/firebird
        sudo ln -s /opt/firebird/bin/isql /usr/local/bin/isql
        sudo ln -s /opt/firebird/bin/gbak /usr/local/bin/gbak
        sudo ln -s /opt/firebird/bin/gfix /usr/local/bin/gfix
        sudo ln -s /opt/firebird/bin/gsec /usr/local/bin/gsec
        sudo chmod -R 755 /opt/firebird
        sudo usermod -a -G firebird $USER
        
        # Create database directory
        sudo mkdir -p /firebird/data
        sudo chown -R firebird:firebird /firebird/data
        sudo chmod 770 /firebird/data
        
        # Start Firebird service
        sudo /opt/firebird/firebird.sh start || true
        sleep 5

    - name: Setup Database
      run: |
        # Wait for Firebird to be ready
        for i in {1..30}; do
          if isql -user sysdba -password masterkey -database /firebird/data/test.fdb -q "SELECT CURRENT_USER FROM RDB$DATABASE" 2>/dev/null; then
            echo "Firebird is ready"
            break
          fi
          echo "Waiting for Firebird... ($i/30)"
          sleep 2
        done
        
        # Create test database if it doesn't exist
        isql -user sysdba -password masterkey -database /firebird/data/test.fdb -q "CREATE DATABASE '/firebird/data/test.fdb' USER 'sysdba' PASSWORD 'masterkey'" || echo "Database already exists"

    - name: Install Dependencies
      run: |
        gem install bundler
        bundle config set --local deployment 'true'
        bundle install --jobs 4 --retry 3

    - name: Run Tests
      env:
        ISC_PASSWORD: masterkey
        FIREBIRD_DATABASE: /firebird/data/test.fdb
      run: |
        echo "Ruby version: $(ruby --version)"
        echo "Rails version: $(ruby -e 'require \"bundler\"; puts Bundler.locked_gems[\"rails\"].version')"
        echo "Firebird version: ${{ matrix.firebird }}"
        
        # Run tests with coverage
        bundle exec rspec --format documentation --format RspecJunitFormatter --out test-results.xml

    - name: Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.ruby }}-${{ matrix.rails }}-${{ matrix.firebird }}
        path: test-results.xml

    - name: Test Summary
      if: always()
      run: |
        echo "## Test Summary"
        echo "- Ruby: ${{ matrix.ruby }}"
        echo "- Rails: ${{ matrix.rails }}"
        echo "- Firebird: ${{ matrix.firebird }}"
        
        # Create status badge
        if [ "${{ job.status }}" = "success" ]; then
          echo "✅ Tests passed"
        else
          echo "❌ Tests failed"
        fi

  # Lint job
  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.6'
        bundler-cache: true

    - name: Install Dependencies
      run: |
        gem install bundler
        bundle config set --local deployment 'true'
        bundle install

    - name: Run RuboCop
      run: |
        bundle exec rubocop --format github

  # Security scan
  security:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Security Audit
      run: |
        gem install bundler-audit
        bundle audit --update

  # Performance test
  performance:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/rails-7-2'
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Ruby and Firebird
      run: |
        ruby --version
        sudo ln -s /opt/firebird5.0/opt/firebird /opt/firebird
        sudo usermod -a -G firebird $USER
        sudo /opt/firebird/firebird.sh start || true
        sleep 3

    - name: Performance Tests
      run: |
        # Basic performance benchmarking
        bundle exec ruby -e "
          require './spec/spec_helper'
          connection = ActiveRecord::Base.connection
          
          puts '=== Performance Benchmarks ==='
          
          # Test 1000 simple queries
          start_time = Time.now
          1000.times do
            connection.select_value('SELECT 1 FROM RDB\$DATABASE')
          end
          end_time = Time.now
          
          puts \"1000 queries: #{(end_time - start_time).round(3)}s\"
          puts \"Queries per second: #{(1000 / (end_time - start_time)).round(2)}\"
        "

  # Compatibility matrix test
  compatibility:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
    - name: Compatibility Report
      run: |
        echo "## Compatibility Matrix Results"
        echo "This job runs after all test matrix jobs complete"
        echo "It will generate a compatibility report for the firebird_adapter"