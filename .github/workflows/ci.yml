name: CI - Firebird Adapter

on:
  push:
    branches: [ rails-7-2, main ]
  pull_request:
    branches: [ rails-7-2, main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    env:
      ISC_PASSWORD: masterkey
      FIREBIRD_DATABASE: /firebird/data/test.fdb

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.6'

    - name: Install Firebird
      run: |
        # Install dependencies
        sudo apt-get update
        sudo apt-get install -y wget tar
        
        # Download and install Firebird 4.0
        wget -q "https://github.com/FirebirdSQL/firebird/releases/download/v4.0.5/firebird4.0-classic-ubuntu20.04-amd64.tar.gz"
        sudo tar -xzf firebird4.0-classic-ubuntu20.04-amd64.tar.gz -C /opt/
        
        # Set up links and permissions
        sudo ln -sf /opt/firebird4.0-classic/opt/firebird /opt/firebird
        sudo ln -sf /opt/firebird/bin/isql /usr/local/bin/isql
        sudo chmod -R 755 /opt/firebird
        
        # Create database directory
        sudo mkdir -p /firebird/data
        sudo chmod 777 /firebird/data
        
        # Start Firebird
        sudo /opt/firebird/firebird.sh start || true
        sleep 5

    - name: Setup Database
      run: |
        # Create test database
        isql -user sysdba -password masterkey -q "CREATE DATABASE '/firebird/data/test.fdb' USER 'sysdba' PASSWORD 'masterkey'" || echo "Database exists"

    - name: Install Dependencies
      run: |
        bundle install

    - name: Run Tests
      run: |
        echo "Ruby version: $(ruby --version)"
        
        # Run tests
        mkdir -p tmp
        bundle exec rspec --format documentation || true

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: tmp/

  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.6'

    - name: Install Dependencies
      run: |
        bundle install

    - name: Run RuboCop
      run: |
        bundle exec rubocop || true

  security:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Security Audit
      run: |
        gem install bundler-audit
        bundle audit --update || true