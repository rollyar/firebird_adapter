name: CI - Firebird 5 via Script (IBSurgeon)

on:
  pull_request:
  push:
    branches: [ rails-7-2, main ]

jobs:
  test:
    runs-on: ubuntu-24.04

    env:
      ISC_PASSWORD: masterkey
      FIREBIRD_DATABASE: /firebird/data/test.fdb

    steps:
      - name: Install system dependencies
        run: |
          sudo apt-get update
          # Instalamos dependencias básicas
          sudo apt-get install -y wget curl libtool build-essential

      - name: Download and Run IBSurgeon Script (FB5)
        run: |
          # Descargamos el script directamente
          curl -L https://raw.githubusercontent.com/IBSurgeon/firebirdlinuxinstall/main/fb_vanilla-50.sh -o fb_install.sh

          # Le damos permisos y ejecutamos
          chmod +x fb_install.sh
          # El script maneja la instalación y el servicio
          sudo ./fb_install.sh

      - name: Configure Environment for Gem Compilation
        run: |
          # El script instala en /opt/firebird. Debemos decirle a Ruby dónde buscar.
          echo "FIREBIRD_INCLUDE=/opt/firebird/include" >> $GITHUB_ENV
          echo "FIREBIRD_LIB=/opt/firebird/lib" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/opt/firebird/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

          # Verificar que Firebird está vivo
          sleep 10
          # Verificamos si el proceso existe en lugar de intentar iniciarlo manualmente
          pgrep fb_inet_server || pgrep fbserver || echo "Server not found (check logs)"

      - name: Setup Test Database
        run: |
          sudo mkdir -p /firebird/data
          sudo chmod 777 /firebird/data
          # Usamos el binario isql que instaló el script en /opt/firebird/bin
          /opt/firebird/bin/isql -u sysdba -p masterkey -q "CREATE DATABASE 'localhost:/firebird/data/test.fdb' USER 'sysdba' PASSWORD 'masterkey';" || echo "Database check"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.6'
          bundler-cache: true

      - name: Verify Gem Compilation
        run: |
          # Intentamos cargar la gema. Aquí es donde verás si falla con FB5
          ruby -r fb -e "puts '✅ FB Gem compiled and loaded successfully'"

      - name: Run Tests
        env:
          RAILS_ENV: test
        run: |
          bundle exec rspec --format documentation

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: firebird-logs
          path: /opt/firebird/
          if-no-files-found: ignore
