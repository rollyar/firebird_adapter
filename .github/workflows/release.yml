name: Release Checks

on:
  push:
    tags:
      - 'v*'
  pull_request:
    paths:
      - 'firebird_adapter.gemspec'
      - 'lib/firebird_adapter/version.rb'

jobs:
  release-validation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.6'
        bundler-cache: true
    
    - name: Install dependencies
      run: bundle install
    
    - name: Validate Version
      run: |
        echo "üè∑Ô∏è Validating version..."
        
        # Get version from files
        VERSION_FILE=$(grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' lib/firebird_adapter/version.rb)
        GEMSPEC_VERSION=$(grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' firebird_adapter.gemspec)
        TAG_VERSION=${GITHUB_REF#refs/tags/v}
        
        echo "Version in file: $VERSION_FILE"
        echo "Version in gemspec: $GEMSPEC_VERSION"
        echo "Tag version: $TAG_VERSION"
        
        if [ "$VERSION_FILE" != "$GEMSPEC_VERSION" ]; then
          echo "‚ùå Version mismatch between version.rb and gemspec"
          exit 1
        fi
        
        if [ -n "$TAG_VERSION" ] && [ "$VERSION_FILE" != "$TAG_VERSION" ]; then
          echo "‚ùå Tag version doesn't match file version"
          exit 1
        fi
        
        echo "‚úÖ Version validation passed"
    
    - name: Build Gem
      run: |
        echo "üèóÔ∏è Building gem..."
        gem build firebird_adapter.gemspec
    
    - name: Validate Gem
      run: |
        echo "üîç Validating gem..."
        gem specification firebird_adapter-*.gem --ruby --validate
    
    - name: Check Gem Contents
      run: |
        echo "üì¶ Checking gem contents..."
        gem unpack firebird_adapter-*.gem
        ls -la firebird_adapter-*/
        rm -rf firebird_adapter-*/
    
    - name: Run Tests Before Release
      run: |
        echo "üß™ Running tests before release..."
        bundle exec rake || echo "‚ö†Ô∏è Some tests failed"
        bundle exec rspec || echo "‚ö†Ô∏è Some specs failed"
    
    - name: Check Changelog
      run: |
        echo "üìÖ Checking changelog..."
        if [ ! -f CHANGELOG.md ]; then
          echo "‚ö†Ô∏è No CHANGELOG.md found"
        else
          echo "‚úÖ CHANGELOG.md exists"
          # Check if changelog has current version entry
          VERSION=$(grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' lib/firebird_adapter/version.rb)
          if grep -q "$VERSION" CHANGELOG.md; then
            echo "‚úÖ Changelog has entry for version $VERSION"
          else
            echo "‚ö†Ô∏è No changelog entry for version $VERSION"
          fi
        fi

  publish:
    needs: release-validation
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.6'
        bundler-cache: true
    
    - name: Install dependencies
      run: bundle install
    
    - name: Build Gem
      run: gem build firebird_adapter.gemspec
    
    - name: Publish to RubyGems
      env:
        GEM_HOST_API_KEY: ${{ secrets.RUBYGEMS_AUTH_TOKEN }}
      run: |
        gem push firebird_adapter-*.gem
    
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false