name: Dependency & Security Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  push:
    paths:
      - 'Gemfile'
      - 'firebird_adapter.gemspec'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.6'
        bundler-cache: true
    
    - name: Install dependencies
      run: bundle install
    
    - name: Security Audit
      run: |
        echo "ğŸ”’ Running security audit..."
        bundle exec bundler-audit --update || echo "âš ï¸ Security audit completed with warnings"
    
    - name: Check for outdated dependencies
      run: |
        echo "ğŸ“¦ Checking for outdated dependencies..."
        bundle outdated || echo "Some dependencies are outdated"
    
    - name: Generate Security Report
      run: |
        echo "ğŸ“‹ Security Report - $(date)"
        echo "========================"
        bundle exec bundler-audit --format json || echo "Audit completed"
        echo "========================"

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout PR
      uses: actions/checkout@v4
    
    - name: Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate